#include "fstream"

#include "DiffFrontendAction.h"
#include "DiffASTConsumer.h"

DiffFrontendAction::DiffFrontendAction(const std::vector<int> &gcovLines, const std::vector<int> &llvmcovLines, const std::filesystem::path &DirPath, const std::vector<DiffParser *> *DiffParserVector)
    : gcovLines(gcovLines), llvmcovLines(llvmcovLines), DirPath(DirPath), DiffParserVector(DiffParserVector){};

std::unique_ptr<clang::ASTConsumer> DiffFrontendAction::CreateASTConsumer(clang::CompilerInstance &Compiler, llvm::StringRef InFile)
{
    const std::vector<int> *lines;
    int *index;
    if (InFile.contains(".gcov"))
    {
        CoverageToolId = 0;
        lines = &gcovLines;
        index = &gcovIndex;
    }
    else if (InFile.contains(".llvm-cov"))
    {
        CoverageToolId = 1;
        lines = &llvmcovLines;
        index = &llvmcovIndex;
    }
    else
    {
        throw std::runtime_error("Unable to tell if the file was generated by gcov or llvm-cov");
    }
    return std::make_unique<DiffASTConsumer>(&Compiler.getASTContext(), *lines, *index, CoverageToolId, InFile, DiffParserVector, DiffReasonVector);
}

void DiffFrontendAction::EndSourceFileAction()
{
    std::filesystem::create_directories(DirPath);
    std::filesystem::path path = DirPath;
    std::string coverageTool;
    const std::vector<int> *lines;
    int index;
    if (CoverageToolId == 0)
    {
        path /= "gcov.map";
        coverageTool = "gcov";
        lines = &gcovLines;
        index = gcovIndex;
    }
    else if (CoverageToolId == 1)
    {
        path /= "llvm-cov.map";
        coverageTool = "llvm-cov";
        lines = &llvmcovLines;
        index = llvmcovIndex;
    }
    else
    {
        throw std::runtime_error("Cannot handle CoverageToolId with value " + CoverageToolId);
    }

    std::ofstream ofs(path);

    for (const auto &reason : DiffReasonVector)
    {
        if (reason->getFileTypeId() == CoverageToolId)
        {
            ofs << reason->getCoverageTool() << ":" << reason->getDescription() << "#" << reason->getCount() << "@" << reason->getLineNum() << "\n";
        }
    }
    while (index < lines->size())
    {
        ofs << "Unkown@" << (*lines)[index++] << "\n";
    }
    ofs << "=================================== Diff Report ===================================\n";
    int total = 0;
    for (const auto &parser : *DiffParserVector)
    {
        if (parser->getFileTypeId() == CoverageToolId)
        {
            int count = parser->getCount();
            total += count;
            ofs << "#" << parser->getCoverageTool() << "@" << parser->getDescription() << ":" << count << "\n";
        }
    }
    ofs << "\n";
    ofs << "Total:" << total << "\n";

    ofs.close();
    llvm::outs() << coverageTool << " diff reason location: " << path << "\n";
}